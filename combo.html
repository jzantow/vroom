<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Coverage Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry" async defer></script>
    
    <style>
        /* Base Styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            overflow: hidden; /* Prevent body scrollbars */
        }

        /* Main Layout */
        .dashboard-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .controls-header {
            flex-shrink: 0;
            background-color: #fff;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .dashboard-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Important for child scrolling */
        }

        /* Panels */
        .map-panel, .table-panel {
            flex: 1;
            height: 100%;
            overflow-y: auto; /* Allow individual scrolling */
        }

        .map-panel {
            position: relative; /* For positioning map overlays */
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Overlays (Legend) */
        #legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 5;
            background: white;
            padding: 10px;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border-radius: 5px;
        }
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 6px;
            vertical-align: middle;
            border-radius: 3px;
        }
        .legend-color.store      { background: #FF6347; }
        .legend-color.station    { background: #1E90FF; }
        .legend-color.billboard { background: #32CD32; }
        
        /* Table Styles */
        .table-panel table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-panel th, .table-panel td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            font-size: 14px;
        }
        .table-panel th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
        }
        .table-highlight {
            background-color: #fefcbf !important; /* Yellow highlight */
        }
    </style>
</head>

<body>

    <div class="dashboard-layout">

        <header class="controls-header">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Coverage Dashboard</h1>
            <div class="flex items-center gap-4">
                <input type="text" id="masterSearchInput" placeholder="Search by Store Name, Store #, ON #, Station, etc..." class="flex-grow w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="resetBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition">Reset</button>
            </div>
        </header>

        <main class="dashboard-container">

            <section class="map-panel">
                <div id="map"></div>
                <div id="legend">
                    <h3>Legend</h3>
                    <p><span class="legend-color store"></span> Store</p>
                    <p><span class="legend-color station"></span> Station</p>
                    <p><span class="legend-color billboard"></span> Billboard</p>
                </div>
            </section>

            <section class="table-panel">
                <div class="overflow-x-auto h-full">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Store</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Radio Coverage</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nearby Billboards</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                    <p id="loadingMessage" class="text-center text-gray-500 mt-8">Loading data...</p>
                    <p id="noResultsMessage" class="text-center text-gray-500 mt-8 hidden">No results found.</p>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        const storeDataURL = 'https://jzantow.github.io/vroom/stores.json';
        const stationDataURL = 'https://jzantow.github.io/vroom/stations.json';
        const billboardDataURL = 'https://jzantow.github.io/vroom/hqbillboards.json';

        let allStores = [], allStations = [], allBillboards = [];
        let map;
        const storeMarkers = [], stationMarkers = [], billboardMarkers = [];
        let circles = [];
        let allStores = [], allStations = [], allBillboards = [];
        let highlightedMarker = null;
        let infoWindow;

        const COLORS = {
            "Store": "#FF6347",
            "Station": "#1E90FF",
            "Billboard": "#32CD32"
        };
        const HIGHLIGHT_ICON = {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 9,
            fillColor: "#FFD700",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "#B8860B"
        };
        
        // --- INITIALIZATION ---
        function initDashboard() {
            initMap();
            loadData();

            document.getElementById('masterSearchInput').addEventListener('input', masterFilter);
            document.getElementById('resetBtn').addEventListener('click', resetDashboard);
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 5,
                center: { lat: 42.53, lng: -114.36 },
                gestureHandling: "greedy",
                mapTypeControl: false,
                scaleControl: true
            });
            infoWindow = new google.maps.InfoWindow();
        }

        function loadData() {
            const storeDataURL = 'https://jzantow.github.io/vroom/stores.json';
            const stationDataURL = 'https://jzantow.github.io/vroom/stations.json';
            const billboardDataURL = 'https://jzantow.github.io/vroom/hqbillboards.json';

            Promise.all([
                fetch(storeDataURL).then(res => res.json()),
                fetch(stationDataURL).then(res => res.json()),
                fetch(billboardDataURL).then(res => res.json())
            ]).then(([storeData, stationData, billboardData]) => {
                allStores = storeData;
                allStations = stationData;
                allBillboards = billboardData;

                createAllMarkers();
                renderTable(allStores);
                
                document.getElementById('loadingMessage').classList.add('hidden');
            }).catch(err => {
                console.error("Failed to load data:", err);
                document.getElementById('loadingMessage').textContent = "Failed to load data.";
            });
        }

        // --- CORE FILTERING AND RENDERING ---
        function masterFilter() {
            const query = document.getElementById('masterSearchInput').value.toLowerCase().trim();
            
            if (!query) {
                renderTable(allStores);
                updateVisibleMarkers(allStores, allStations, allBillboards);
                return;
            }

            const filteredStores = allStores.filter(store => {
                const storeInfo = (store.Name || '').toLowerCase();
                if (storeInfo.includes(query)) return true;

                const inRangeStations = findInRangeItems(store, allStations);
                const stationMatch = inRangeStations.some(st => (st.Name || '').toLowerCase().includes(query));
                if (stationMatch) return true;

                const inRangeBillboards = findInRangeItems(store, allBillboards);
                const billboardMatch = inRangeBillboards.some(bb => (`on #${bb.Name}` || '').toLowerCase().includes(query));
                if (billboardMatch) return true;
                
                return false;
            });
            
            const filteredStations = allStations.filter(st => (st.Name || '').toLowerCase().includes(query));
            const filteredBillboards = allBillboards.filter(bb => (`on #${bb.Name}` || '').toLowerCase().includes(query));

            renderTable(filteredStores);
            updateVisibleMarkers(filteredStores, filteredStations, filteredBillboards);
        }

        function renderTable(storesToDisplay) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            document.getElementById('noResultsMessage').classList.toggle('hidden', storesToDisplay.length > 0);

            storesToDisplay.forEach(store => {
                const inRangeStations = findInRangeItems(store, allStations);
                const inRangeBillboards = findInRangeItems(store, allBillboards);

                const row = document.createElement('tr');
                row.setAttribute('data-store-name', store.Name); // Link for map interaction
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <strong class="font-semibold">${store.Name || 'N/A'}</strong>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${inRangeStations.length ? inRangeStations.map(st => `
                            <div class="mb-2 last:mb-0"><strong>${st.Name || 'N/A'}</strong> (${st.Genre || 'N/A'})</div>
                        `).join('') : 'None'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${inRangeBillboards.length ? inRangeBillboards.map(bb => `
                            <div class="mb-2 last:mb-0"><strong>ON #: ${bb.Name || 'N/A'}</strong></div>
                        `).join('') : 'None'}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateVisibleMarkers(stores, stations, billboards) {
            const storeNames = new Set(stores.map(s => s.Name));
            const stationNames = new Set(stations.map(s => s.Name));
            const billboardNames = new Set(billboards.map(b => b.Name));

            storeMarkers.forEach(marker => marker.setMap(storeNames.has(marker.customId) ? map : null));
            stationMarkers.forEach(marker => marker.setMap(stationNames.has(marker.customId) ? map : null));
            billboardMarkers.forEach(marker => marker.setMap(billboardNames.has(marker.customId) ? map : null));

            circles.forEach(circle => {
                const isVisible = (circle.type === 'Station' && stationNames.has(circle.customId)) ||
                                  (circle.type === 'Billboard' && billboardNames.has(circle.customId));
                circle.setMap(isVisible ? map : null);
            });
        }
        
        // --- MAP MARKER CREATION AND HANDLING ---
        function createAllMarkers() {
            const allData = [...allStores, ...allStations, ...allBillboards];
            allData.forEach(loc => {
                const position = { lat: loc.Latitude, lng: loc.Longitude };
                const color = COLORS[loc.Type];

                if (loc.Type === "Station" || loc.Type === "Billboard") {
                    const circle = new google.maps.Circle({
                        strokeColor: color, strokeOpacity: 0.6, strokeWeight: 1.5,
                        fillColor: color, fillOpacity: 0.2,
                        center: position,
                        radius: (loc.Radius || 0) * 1609.34,
                        map: map, clickable: false
                    });
                    circle.type = loc.Type;
                    circle.customId = loc.Name;
                    circles.push(circle);
                }

                const defaultIcon = {
                    path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: color,
                    fillOpacity: 1, strokeWeight: 1, strokeColor: "#fff"
                };

                const marker = new google.maps.Marker({
                    position: position, map: map,
                    title: String(loc.Name), icon: defaultIcon
                });
                marker.defaultIcon = defaultIcon;
                marker.customId = loc.Name; // Unique ID for filtering

                if (loc.Type === "Store") {
                    addStoreClickListener(marker, loc);
                    storeMarkers.push(marker);
                } else if (loc.Type === "Station") {
                    addStationClickListener(marker, loc);
                    stationMarkers.push(marker);
                } else if (loc.Type === "Billboard") {
                    addBillboardClickListener(marker, loc);
                    billboardMarkers.push(marker);
                }
            });
        }

        // --- MARKER CLICK LISTENERS ---
        function addStoreClickListener(marker, loc) {
            marker.addListener("click", () => {
                highlightMarker(marker);
                highlightTableRow(loc.Name);
                
                const inRangeStations = findInRangeItems(loc, allStations).map(st => st["Coverage Map"] ? `<a href="${st["Coverage Map"]}" target="_blank">${st.Name}</a>` : st.Name);
                const inRangeBillboards = findInRangeItems(loc, allBillboards).map(bb => bb.Creative ? `<a href="${bb.Creative}" target="_blank">ON #${bb.Name}</a>` : `ON #${bb.Name}`);
                
                const content = `<strong>${loc.Name}</strong><br><br><b>Stations In Range:</b><br>${inRangeStations.length ? inRangeStations.join("<br>") : "None"}<br><br><b>Nearby Billboards:</b><br>${inRangeBillboards.length ? inRangeBillboards.join("<br>") : "None"}`;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        }
        function addStationClickListener(marker, loc) {
             marker.addListener("click", () => {
                highlightMarker(marker);
                let content = `<strong>${loc.Name}</strong><br>` +
                              `<b>Genre:</b> ${loc.Genre || "N/A"}<br>` +
                              `<b>Station Rank:</b> ${loc.Rank || "N/A"}<br>` +
                              (loc["Coverage Map"] ? `<b>Coverage Map:</b> <a href="${loc["Coverage Map"]}" target="_blank">View Map</a><br>` : `<b>Coverage Map:</b> N/A<br>`) +
                              `<b>Buy Region:</b> ${loc["Buy Region"] || "N/A"}`;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        }
        function addBillboardClickListener(marker, loc) {
            marker.addListener("click", () => {
                highlightMarker(marker);
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.Latitude},${loc.Longitude}`;
                const content = `<strong>ON #${loc.Name}</strong><br>` +
                                `<b>Lat, Lng:</b> <a href="${mapsUrl}" target="_blank">${loc.Latitude}, ${loc.Longitude}</a><br>` +
                                `<b>Board Type:</b> ${loc["Board Type"] || "N/A"}<br>` +
                                `<b>Location:</b> ${loc.Info || "N/A"}`;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        }

        // --- HELPER & UTILITY FUNCTIONS ---
        function findInRangeItems(store, items) {
            const storeLatLng = new google.maps.LatLng(store.Latitude, store.Longitude);
            return items.filter(item => {
                const itemLatLng = new google.maps.LatLng(item.Latitude, item.Longitude);
                const distance = google.maps.geometry.spherical.computeDistanceBetween(storeLatLng, itemLatLng);
                return distance <= (item.Radius || 0) * 1609.34;
            });
        }

        function highlightMarker(marker) {
            if (highlightedMarker) {
                highlightedMarker.setIcon(highlightedMarker.defaultIcon);
            }
            marker.setIcon(HIGHLIGHT_ICON);
            highlightedMarker = marker;
        }

        function highlightTableRow(storeName) {
            document.querySelectorAll('#tableBody tr').forEach(row => {
                row.classList.remove('table-highlight');
            });
            const rowToHighlight = document.querySelector(`#tableBody tr[data-store-name="${storeName}"]`);
            if (rowToHighlight) {
                rowToHighlight.classList.add('table-highlight');
                rowToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        function resetDashboard() {
            document.getElementById('masterSearchInput').value = '';
            infoWindow.close();
            if (highlightedMarker) {
                highlightedMarker.setIcon(highlightedMarker.defaultIcon);
                highlightedMarker = null;
            }
            map.setZoom(5);
            map.setCenter({ lat: 42.53, lng: -114.36 });

            renderTable(allStores);
            updateVisibleMarkers(allStores, allStations, allBillboards);
            document.querySelectorAll('#tableBody tr').forEach(row => row.classList.remove('table-highlight'));
        }

        // --- SCRIPT EXECUTION ---
        window.onload = initDashboard;
    </script>
</body>
</html>
