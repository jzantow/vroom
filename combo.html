<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Coverage Dashboard</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry" async defer></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CORE LAYOUT --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            overflow: hidden; /* Prevent body scrollbars */
        }
        .dashboard-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .controls-header {
            flex-shrink: 0;
            background-color: #fff;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 20;
        }
        .dashboard-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .map-panel, .table-panel {
            flex: 1; /* Each panel takes 50% width */
            height: 100%;
            overflow-y: auto; /* Allow independent scrolling */
            position: relative;
        }
        .table-panel {
            border-left: 1px solid #e2e8f0;
        }
        
        /* --- MAP & OVERLAYS --- */
        #map {
            width: 100%;
            height: 100%;
        }
        #legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 5;
            background: white;
            padding: 10px;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border-radius: 5px;
        }
        .legend-color { display: inline-block; width: 15px; height: 15px; margin-right: 6px; vertical-align: middle; border-radius: 3px; }
        .legend-color.store { background: #FF6347; }
        .legend-color.station { background: #1E90FF; }
        .legend-color.billboard { background: #32CD32; }

        /* --- TABLE & CONTROLS --- */
        .table-container-inner { padding: 1.5rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; vertical-align: top; font-size: 14px; }
        th { background-color: #f8fafc; font-weight: 600; color: #4a5568; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #f8fafc; }
        tr.highlight-row { background-color: #fffbeb !important; } /* Yellow highlight for interactivity */

        /* Dropdown Styles from original file */
        .dropdown-container { position: relative; width: 100%; }
        .dropdown-button { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; cursor: pointer; background-color: #fff; font-size: 14px; }
        .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; max-height: 200px; overflow-y: auto; background-color: #fff; border: 1px solid #e2e8f0; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 4px; display: none; }
        .dropdown-list.open { display: block; }
        .dropdown-item { display: flex; align-items: center; padding: 0.5rem 0.75rem; cursor: pointer; }
        .dropdown-item:hover { background-color: #f0f4f8; }
        .dropdown-search { width: 100%; padding: 0.5rem 0.75rem; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>

    <div class="dashboard-layout">
        <header class="controls-header">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-grow w-full">
                    <label for="masterSearchInput" class="text-sm font-medium text-gray-700">Master Search</label>
                    <input type="text" id="masterSearchInput" placeholder="Search Stores, Stations, ON #..." class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                </div>

                <div class="flex-shrink-0 w-full md:w-64">
                    <label for="storeDropdownButton" class="block text-sm font-medium text-gray-700">Filter by Store</label>
                    <div class="dropdown-container mt-1">
                        <button id="storeDropdownButton" class="dropdown-button">
                            <span id="storeDropdownLabel">Show All Stores</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="storeDropdownList" class="dropdown-list">
                            <input type="text" id="storeDropdownSearch" class="dropdown-search" placeholder="Search stores...">
                            <div id="storeCheckboxes"></div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 flex gap-4 items-center pt-6">
                    <label class="flex items-center"><input type="checkbox" id="storesCheckbox" checked class="mr-1">Stores</label>
                    <label class="flex items-center"><input type="checkbox" id="stationsCheckbox" checked class="mr-1">Stations</label>
                    <label class="flex items-center"><input type="checkbox" id="billboardsCheckbox" checked class="mr-1">Billboards</label>
                </div>
                
                <div class="flex-shrink-0 pt-6">
                     <button id="resetBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md shadow hover:bg-gray-700">Reset</button>
                </div>
            </div>
        </header>

        <main class="dashboard-container">
            <section class="map-panel">
                <div id="map"></div>
                <div id="legend"></div>
            </section>

            <section class="table-panel">
                <div class="table-container-inner">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr><th>Store</th><th>Radio Coverage</th><th>Nearby Billboards</th></tr>
                            </thead>
                            <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <p id="loadingMessage" class="text-center text-gray-500 mt-8">Loading data...</p>
                    <p id="noResultsMessage" class="text-center text-gray-500 mt-8 hidden">No results found.</p>
                </div>
            </section>
        </main>
    </div>

<script>
// --- FALLBACK SCRIPT ---
window.google = window.google || {};
window.google.maps = window.google.maps || {};
window.google.maps.geometry = window.google.maps.geometry || {};
window.google.maps.geometry.spherical = window.google.maps.geometry.spherical || {};
window.google.maps.LatLng = window.google.maps.LatLng || function(lat, lng) { this.lat = () => lat; this.lng = () => lng; };
window.google.maps.geometry.spherical.computeDistanceBetween = window.google.maps.geometry.spherical.computeDistanceBetween || function(from, to) { console.warn("Using fallback distance calculation. Map features are disabled."); const R = 6371e3; const lat1 = from.lat() * Math.PI / 180; const lat2 = to.lat() * Math.PI / 180; const dLat = (to.lat() - from.lat()) * Math.PI / 180; const dLon = (to.lng() - from.lng()) * Math.PI / 180; const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; };

// --- GLOBAL VARIABLES ---
let map, infoWindow;
let allStores = [], allStations = [], allBillboards = [];
const storeMarkers = [], stationMarkers = [], billboardMarkers = [];
let circles = [], highlightedMarker = null;
let mapInitialized = false; 
const COLORS = { "Store": "#FF6347", "Station": "#1E90FF", "Billboard": "#32CD32" };
const GOLD_MARKER = { path: google.maps.SymbolPath.CIRCLE, scale: 9, fillColor: "#FFD700", fillOpacity: 1, strokeWeight: 2, strokeColor: "#B8860B" };

// --- INITIALIZATION ---
window.onload = function() {
    try {
        initMap();
        mapInitialized = true;
    } catch (error) {
        console.error("Google Maps API failed to load.", error);
        displayMapError();
    }
    loadData();
    setupEventListeners();
};

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), { zoom: 5, center: { lat: 42.53, lng: -114.36 }, gestureHandling: "greedy", mapTypeControl: false, scaleControl: true });
    infoWindow = new google.maps.InfoWindow();
    document.getElementById('legend').innerHTML = `<h3>Legend</h3><p><span class="legend-color store"></span> Store</p><p><span class="legend-color station"></span> Station</p><p><span class="legend-color billboard"></span> Billboard</p>`;
}

function displayMapError() {
    document.getElementById('map').innerHTML = `<div style="padding: 20px; text-align: center; color: #555; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;"><h2>Map Failed to Load</h2><p>Please check your API key and internet connection. Table functionality is still available.</p></div>`;
    document.getElementById('legend').style.display = 'none';
}

function loadData() {
    const storeDataURL = 'https://jzantow.github.io/vroom/stores.json';
    const stationDataURL = 'https://jzantow.github.io/vroom/stations.json';
    const billboardDataURL = 'https://jzantow.github.io/vroom/hqbillboards.json';
    Promise.all([
        fetch(storeDataURL).then(res => res.json()),
        fetch(stationDataURL).then(res => res.json()),
        fetch(billboardDataURL).then(res => res.json())
    ]).then(([storeData, stationData, billboardData]) => {
        allStores = storeData;
        allStations = stationData;
        allBillboards = billboardData;
        if (mapInitialized) createAllMarkers();
        generateStoreNameFilters();
        renderTable(allStores);
        document.getElementById('loadingMessage').classList.add('hidden');
    }).catch(err => {
        console.error("Data fetch failed:", err);
        document.getElementById('loadingMessage').textContent = "Failed to load data files.";
    });
}

// --- CORE FILTERING & RENDERING ---
function masterFilter() {
    const query = document.getElementById('masterSearchInput').value.trim().toLowerCase();
    const checkedStoreNames = Array.from(document.querySelectorAll('#storeCheckboxes input:checked')).map(cb => cb.value);
    let singleStoreToHighlight = null;
    if (query) {
        const potentialMatches = allStores.filter(store => store.Name.toLowerCase().includes(query));
        if (potentialMatches.length === 1) { singleStoreToHighlight = potentialMatches[0].Name; }
    }
    if (!singleStoreToHighlight && checkedStoreNames.length === 1) { singleStoreToHighlight = checkedStoreNames[0]; }
    if (singleStoreToHighlight) {
        renderTable(allStores); 
        if (mapInitialized) { updateVisibleMarkers(allStores); }
        handleTableRowClick(singleStoreToHighlight);
    } else {
        let storesToDisplay = (checkedStoreNames.length > 0) ? allStores.filter(store => checkedStoreNames.includes(store.Name)) : allStores;
        if (query) {
            storesToDisplay = storesToDisplay.filter(store => {
                if ((store.Name || '').toLowerCase().includes(query)) return true;
                const inRangeStations = findInRangeItems(store, allStations);
                if (inRangeStations.some(st => (st.Name || '').toLowerCase().includes(query))) return true;
                const inRangeBillboards = findInRangeItems(store, allBillboards);
                if (inRangeBillboards.some(bb => (`on #${bb.Name}` || '').toLowerCase().includes(query))) return true;
                return false;
            });
        }
        renderTable(storesToDisplay);
        if (mapInitialized) { updateVisibleMarkers(storesToDisplay); }
    }
}

function renderTable(stores) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    document.getElementById('noResultsMessage').classList.toggle('hidden', stores.length > 0);
    stores.forEach(store => {
        const inRangeStations = findInRangeItems(store, allStations);
        const inRangeBillboards = findInRangeItems(store, allBillboards);
        const row = document.createElement('tr');
        row.setAttribute('data-store-name', store.Name);
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => handleTableRowClick(store.Name));
        row.innerHTML = `<td class="font-semibold">${store.Name || 'N/A'}</td><td>${inRangeStations.length ? inRangeStations.map(st => `<div><strong>${st.Name}</strong> (${st.Genre || 'N/A'})</div>`).join('') : 'None'}</td><td>${inRangeBillboards.length ? inRangeBillboards.map(bb => `<div><strong>ON #${bb.Name}</strong></div>`).join('') : 'None'}</td>`;
        tableBody.appendChild(row);
    });
}

function updateVisibleMarkers(storesToShow) {
    if (!mapInitialized) return;
    const storeNamesToShow = new Set(storesToShow.map(s => s.Name));
    storeMarkers.forEach(marker => { marker.setVisible(storeNamesToShow.has(marker.customData.Name)); });
}

// --- MAP-SPECIFIC FUNCTIONS ---
function createAllMarkers() {
    if (!mapInitialized) return;
    const allData = [...allStores, ...allStations, ...allBillboards];
    allData.forEach(loc => {
        const position = { lat: loc.Latitude, lng: loc.Longitude };
        const color = COLORS[loc.Type];
        if (loc.Type === "Station" || loc.Type === "Billboard") {
            const circle = new google.maps.Circle({ strokeColor: color, strokeOpacity: 0.7, strokeWeight: 1.5, fillColor: color, fillOpacity: 0.2, map: map, center: position, radius: (loc.Radius || 0) * 1609.34, });
            circle.customType = loc.Type; 
            circles.push(circle);
        }
        const defaultIcon = { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: color, fillOpacity: 1, strokeWeight: 1, strokeColor: "#fff" };
        const marker = new google.maps.Marker({ position, map, icon: defaultIcon, title: String(loc.Name) });
        marker.customData = loc;
        marker.defaultIcon = defaultIcon;
        if (loc.Type === "Store") {
            marker.addListener("click", () => handleStoreMarkerClick(marker));
            storeMarkers.push(marker);
        } else if (loc.Type === "Station") {
            marker.addListener("click", () => handleStationMarkerClick(marker));
            stationMarkers.push(marker);
        } else if (loc.Type === "Billboard") {
            marker.addListener("click", () => handleBillboardMarkerClick(marker));
            billboardMarkers.push(marker);
        }
    });
}

// --- INTERACTIVITY HANDLERS ---
function handleTableRowClick(storeName) {
    document.querySelectorAll('#tableBody tr').forEach(r => r.classList.remove('highlight-row'));
    const row = document.querySelector(`tr[data-store-name="${storeName}"]`);
    if (row) row.classList.add('highlight-row');
    if (!mapInitialized) return;
    const marker = storeMarkers.find(m => m.customData.Name === storeName);
    if (marker) {
        map.panTo(marker.getPosition());
        map.setZoom(10);
        google.maps.event.trigger(marker, 'click');
    }
}

// --- UPDATED POP-UP LOGIC STARTS HERE ---

function handleStoreMarkerClick(marker) {
    if (!mapInitialized) return;
    highlightMarker(marker);
    highlightTableRow(marker.customData.Name);
    const loc = marker.customData;
    
    const inRangeStations = findInRangeItems(loc, allStations).map(st => {
        return st["Coverage Map"] ? `<a href="${st["Coverage Map"]}" target="_blank">${st.Name}</a>` : st.Name;
    });
    
    const inRangeBillboards = findInRangeItems(loc, allBillboards).map(bb => {
        return bb.Creative ? `<a href="${bb.Creative}" target="_blank">ON #${bb.Name}</a>` : `ON #${bb.Name}`;
    });

    const content = `
        <div style="font-size: 14px; max-width: 250px;">
            <strong style="font-size: 16px;">${loc.Name}</strong><br><br>
            <b>Stations In Range:</b><br>
            ${inRangeStations.length ? inRangeStations.join("<br>") : "None"}
            <br><br>
            <b>Nearby Billboards:</b><br>
            ${inRangeBillboards.length ? inRangeBillboards.join("<br>") : "None"}
        </div>
    `;
    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

function handleStationMarkerClick(marker) {
    if (!mapInitialized) return;
    highlightMarker(marker);
    const loc = marker.customData;
    let content = `
        <div style="font-size: 14px; max-width: 250px;">
            <strong style="font-size: 16px;">${loc.Name}</strong><br><br>
            <strong>Genre:</strong> ${loc.Genre || "N/A"}<br>
            <strong>Station Rank:</strong> ${loc.Rank || "N/A"}<br>
            <strong>Buy Region:</strong> ${loc["Buy Region"] || "N/A"}<br>
            <strong>Coverage Map:</strong> 
            ${loc["Coverage Map"] ? `<a href="${loc["Coverage Map"]}" target="_blank">View Map</a>` : "N/A"}
        </div>
    `;
    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

function handleBillboardMarkerClick(marker) {
    if (!mapInitialized) return;
    highlightMarker(marker);
    const loc = marker.customData;
    const mapsUrl = `http://googleusercontent.com/maps/google.com/0{loc.Latitude},${loc.Longitude}`;
    const content = `
        <div style="font-size: 14px; max-width: 300px; max-height: 250px; overflow-y: auto;">
            <strong style="font-size: 16px;">ON #${loc.Name}</strong><br><br>
            <b>Latitude, Longitude:</b> <a href="${mapsUrl}" target="_blank">${loc.Latitude}, ${loc.Longitude}</a><br>
            <b>Board Type:</b> ${loc["Board Type"] || "N/A"}<br>
            <b>Location:</b> ${loc.Info || "N/A"}<br>
            <b>Live Dates:</b><br><div style="padding-left: 10px;">${(loc["Live Dates"] || "N/A").replace(/\n/g, "<br>")}</div>
            <b>Buyer:</b> ${loc.Buyer || "N/A"}<br>
            <b>Associated Store(s):</b> ${loc["Associated Store(s)"] || "N/A"}<br>
            <b>Directional:</b> ${loc.Directional || "N/A"}<br>
            <b>Creative:</b> ${loc.Creative ? `<a href="${loc.Creative}" target="_blank">View</a>` : "N/A"}<br>
            ${loc["POP Photo"] ? `<b>POP Photo:</b> <a href="${loc["POP Photo"]}" target="_blank">View</a>` : ""}
        </div>
    `;
    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

// --- END OF UPDATED POP-UP LOGIC ---


function highlightTableRow(storeName) {
    document.querySelectorAll('#tableBody tr').forEach(r => r.classList.remove('highlight-row'));
    const row = document.querySelector(`tr[data-store-name="${storeName}"]`);
    if (row) {
        row.classList.add('highlight-row');
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}
function highlightMarker(marker) {
    if (!mapInitialized) return;
    if (highlightedMarker) {
        highlightedMarker.setIcon(highlightedMarker.defaultIcon);
    }
    marker.setIcon(GOLD_MARKER);
    highlightedMarker = marker;
}
function findInRangeItems(sourceItem, targetItems) {
    const sourceLatLng = new google.maps.LatLng(sourceItem.Latitude, sourceItem.Longitude);
    return targetItems.filter(item => {
        const itemLatLng = new google.maps.LatLng(item.Latitude, item.Longitude);
        return google.maps.geometry.spherical.computeDistanceBetween(sourceLatLng, itemLatLng) <= (item.Radius || 0) * 1609.34;
    });
}

// --- EVENT LISTENERS ---
function setupEventListeners() {
    document.getElementById('masterSearchInput').addEventListener('input', masterFilter);
    document.getElementById('storesCheckbox').addEventListener('change', () => { if(mapInitialized) storeMarkers.forEach(m => m.setVisible(document.getElementById('storesCheckbox').checked)); });
    document.getElementById('stationsCheckbox').addEventListener('change', () => { 
        if(mapInitialized) {
            const isVisible = document.getElementById('stationsCheckbox').checked;
            stationMarkers.forEach(m => m.setVisible(isVisible));
            circles.forEach(c => { if (c.customType === 'Station') c.setVisible(isVisible); }); 
        }
    });
    document.getElementById('billboardsCheckbox').addEventListener('change', () => { 
        if(mapInitialized) {
            const isVisible = document.getElementById('billboardsCheckbox').checked;
            billboardMarkers.forEach(m => m.setVisible(isVisible));
            circles.forEach(c => { if (c.customType === 'Billboard') c.setVisible(isVisible); }); 
        }
    });
    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('masterSearchInput').value = '';
        document.querySelectorAll('#storeCheckboxes input').forEach(cb => cb.checked = false);
        updateDropdownLabel();
        if (highlightedMarker) {
            highlightedMarker.setIcon(highlightedMarker.defaultIcon);
            highlightedMarker = null;
        }
        masterFilter();
        if (mapInitialized) {
            map.panTo({ lat: 42.53, lng: -114.36 });
            map.setZoom(5);
            infoWindow.close();
        }
    });
    const dropdownBtn = document.getElementById('storeDropdownButton');
    const dropdownList = document.getElementById('storeDropdownList');
    dropdownBtn.addEventListener('click', () => dropdownList.classList.toggle('open'));
    document.getElementById('storeDropdownSearch').addEventListener('input', e => { const filter = e.target.value.toLowerCase(); document.querySelectorAll('#storeCheckboxes .dropdown-item').forEach(item => { item.style.display = item.textContent.toLowerCase().includes(filter) ? 'flex' : 'none'; }); });
    document.addEventListener('click', e => { if (!dropdownList.contains(e.target) && !dropdownBtn.contains(e.target)) dropdownList.classList.remove('open'); });
}

function generateStoreNameFilters() {
    const container = document.getElementById('storeCheckboxes');
    container.innerHTML = '';
    [...new Set(allStores.map(s => s.Name))].sort().forEach(name => {
        const div = document.createElement('div');
        div.className = 'dropdown-item';
        div.innerHTML = `<input type="checkbox" value="${name}" class="mr-2"><span class="text-sm">${name}</span>`;
        div.querySelector('input').addEventListener('change', masterFilter);
        container.appendChild(div);
    });
    container.addEventListener('change', updateDropdownLabel);
}

function updateDropdownLabel() {
    const checked = document.querySelectorAll('#storeCheckboxes input:checked');
    const label = document.getElementById('storeDropdownLabel');
    if (checked.length === 0) label.textContent = 'Show All Stores';
    else if (checked.length === 1) label.textContent = checked[0].value;
    else label.textContent = `${checked.length} Stores Selected`;
}
</script>
</body>
</html>
